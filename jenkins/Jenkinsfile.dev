pipeline {
    agent { label 'jupiter-16G-1' }  // Using riscv machine (milk-v/jupiter)

    environment {
        SYSTMP = "${WORKSPACE}/tmp"  
        USER_AGENT = "Mozilla/5.0"  

        EXCLUDE_CACHED = "YES"
        FORCE_REBUILD_ALL = "NO"
        KEEP_LOGS = "NO"
        NOTIFY_DISCORD = "NO"
    }

    stages {
        stage('Clone Repository') {
            steps {
                checkout scm
                sh '''#!/bin/bash
                    mkdir -p "${WORKSPACE}/main/x86_64-Linux"
                    mkdir -p "${SYSTMP}"
                '''
            }
        }

        stage('Setup Environment') {
            steps {
                sh '''#!/bin/bash
                    set -x
                    echo "ðŸ“¦ Setting up build environment..."
                    
                    # Install core dependencies (without sudo)
                    apt-get update -y && apt-get install -y \
                        bc coreutils curl dos2unix fdupes jq moreutils wget \
                        apt-transport-https apt-utils ca-certificates gnupg2 \
                        p7zip-full rename rsync software-properties-common texinfo tmux util-linux
                    
                    export SYSTMP="${WORKSPACE}/tmp"
                    mkdir -p "${SYSTMP}"
                    echo "SYSTMP=${SYSTMP}" > "${WORKSPACE}/env.properties"
                    
                    # Set user agent
                    USER_AGENT="$(curl -qfsSL 'https://raw.githubusercontent.com/pkgforge/devscripts/main/Misc/User-Agents/ua_firefox_macos_latest.txt')"
                    echo "USER_AGENT=${USER_AGENT}" >> "${WORKSPACE}/env.properties"
                    
                    # Timezone setup
                    # TODO 
    
                '''
            }
        }

        stage('Install Addons') {
            environment {
                SYSTMP = "${WORKSPACE}/tmp"  
                LOCAL_BIN = "${WORKSPACE}/.local/bin"
            }
            steps {
                sh '''#!/bin/bash
                    set -x
                    set +e
                    
                    echo "ðŸ“¥ Installing tools to ${LOCAL_BIN}..."
                    mkdir -p "${LOCAL_BIN}"
                    
                    # Install rclone locally
                    curl -qfsSL "${BIN_CACHE_URL}/$(uname -m)/rclone" -o "${LOCAL_BIN}/rclone"
                    chmod +x "${LOCAL_BIN}/rclone"
                    
                    # Install notify tool
                    curl -qfsSL "${BIN_CACHE_URL}/$(uname -m)/notify" -o "${LOCAL_BIN}/notify"
                    chmod +x "${LOCAL_BIN}/notify"
                    
                    # Setup Minisign
                    mkdir -p "${WORKSPACE}/.minisign"
                    echo "$MINISIGN_KEY" > "${WORKSPACE}/.minisign/pkgforge.key"
                    
                    # Update PATH
                    echo "export PATH=\"${LOCAL_BIN}:\\$PATH\"" >> ~/.bashrc
                    source ~/.bashrc
                '''
            }
        }

        stage('Sanity Checks') {
            environment {
                SYSTMP = "${WORKSPACE}/tmp"  
                LOCAL_BIN = "${WORKSPACE}/.local/bin"
            }
            steps {
                sh '''#!/bin/bash
                    echo "export PATH=\"${LOCAL_BIN}:\\$PATH\"" >> ~/.bashrc
                    source ~/.bashrc
                    set +e
                    echo "ðŸ” Running pre-build checks..."
                    
                    # Package count verification
                    PKG_COUNT=$(curl -qfsSL "https://raw.githubusercontent.com/pkgforge/bincache/main/SBUILD_LIST.json" | jq -r '.[] | .pkg_family' | wc -l | tr -d '[:space:]')
                    if [[ "${PKG_COUNT}" -le 10 ]]; then
                        echo "âŒ FATAL: Too few Packages to Build (${PKG_COUNT})"
                        exit 1
                    fi
                    
                    # Dependency verification
                    command -v rclone >/dev/null || {
                        echo "âŒ rclone not found in PATH"
                        exit 1
                    }
                '''
            }
        }

        stage('Build Packages') {
            environment {
                SYSTMP = "${WORKSPACE}/tmp"  
                EXCLUDE_CACHED = "YES"
                FORCE_REBUILD_ALL = "NO"
                LOCAL_BIN = "${WORKSPACE}/.local/bin"
                PKG_REPO = "bincache"
                HOST_TRIPLET = "riscv64-Linux"  // Changed to match your architecture
            }
            steps {
                sh '''#!/bin/bash
                    set -x
                    echo "ðŸ—ï¸ Starting package builds..."
                    
                    # Create local installation directories
                    mkdir -p "${LOCAL_BIN}"
                    export PATH="${LOCAL_BIN}:${PATH}"
                    
                    # Download builder script
                    curl -qfsSL "https://raw.githubusercontent.com/pkgforge/bincache/main/scripts/runner/builder.sh" -o "${SYSTMP}/BUILDER.sh"
                    
                    # Apply critical patches
                    sed -i '
                        # Remove sudo commands
                        s/sudo //g
                        # Disable sudo checks
                        /require_sudo()/,/^}/d
                        # Change system paths to local paths
                        s|/usr/local|'"${LOCAL_BIN}"'|g
                        s|/etc/|'"${WORKSPACE}"'/.local/etc/|g
                    ' "${SYSTMP}/BUILDER.sh"
                    
                    # Create local setup script
                    cat > "${SYSTMP}/setup_local.sh" <<'EOF'
        #!/bin/bash
        echo "[+] Using local setup (no sudo)"
        export CONTINUE="YES"
        export PREFIX="'"${WORKSPACE}"'/.local"
        export PATH="${PREFIX}/bin:${PATH}"
        mkdir -p "${PREFIX}/bin"
        EOF
                    
                    chmod +x "${SYSTMP}/setup_local.sh"
                    
                    # Patch initialization script reference
                    sed -i 's|setup_${HOST_TRIPLET_R}.sh|setup_local.sh|g' "${SYSTMP}/BUILDER.sh"
                    
                    dos2unix "${SYSTMP}/BUILDER.sh"
                    chmod +x "${SYSTMP}/BUILDER.sh"
                    
                    # Set environment variables
                    export HOME="${WORKSPACE}"
                    export TMPDIR="${SYSTMP}"
                    
                    # Execute build
                    "${SYSTMP}/BUILDER.sh" | tee "${SYSTMP}/BUILD.log"
                    
                    # Check result
                    if grep -qi "completed" "${SYSTMP}/BUILD.log"; then
                        echo "âœ… Build completed successfully"
                    else
                        echo "âŒ Build encountered errors"
                        grep -i "error\\|fail" "${SYSTMP}/BUILD.log" || true
                        exit 1
                    fi
                '''
            }
        }

        stage('Post-Build Cleanup') {
            steps {
                sh '''#!/bin/bash
                    echo "ðŸ§¹ Cleaning up temporary files..."
                    if [[ "${KEEP_LOGS}" != "YES" ]]; then
                        rm -rf "${SYSTMP}"
                    fi
                '''
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: '**/BUILD.log', allowEmptyArchive: true
            sh '''#!/bin/bash
                echo "ðŸ§¹ Cleaning up temporary files..."
                rm -rf "${SYSTMP}"  // Cleanup unless KEEP_LOGS is set
            '''
        }
        success {
            echo "ðŸŽ‰ Pipeline completed successfully"
        }
        failure {
            echo "âŒ Pipeline failed - check build logs"
        }
    }
}